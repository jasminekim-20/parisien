<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>parisien</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width: 860px; margin: 40px auto; padding: 0 16px; background: #fafafa; }
        h1 { margin: 0 0 8px; }
        .muted { color: #666; font-size: 14px; margin: 0 0 18px; }

        .panel { background: #fff; border: 1px solid #e7e7e7; border-radius: 14px; padding: 16px; margin: 14px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }

        .day-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .tab { border: 1px solid #ddd; background: #fff; border-radius: 999px; padding: 10px 14px; cursor: pointer; }
        .tab.active { border-color: #111; font-weight: 700; }

        .slot-title { display:flex; align-items:center; justify-content:space-between; margin: 0 0 10px; }
        .slot-title h2 { margin: 0; font-size: 18px; }
        .slot-title span { color:#888; font-size: 13px; }

        .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
        @media (max-width: 720px) { .grid-2 { grid-template-columns: 1fr; } }

        .opt { border: 1px solid #e3e3e3; border-radius: 12px; padding: 12px; cursor: pointer; transition: transform .06s ease, border-color .06s ease; background: #fff; }
        .opt:hover { transform: translateY(-1px); border-color: #cfcfcf; }
        .opt.selected { border-color: #111; box-shadow: 0 0 0 2px rgba(0,0,0,0.06); }

        .opt-head { display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; }
        .opt-label { margin: 0; font-weight: 800; }
        .opt-place { margin: 6px 0 0; color:#555; font-size: 13px; }

        .img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; display:block; margin: 10px 0 0; background:#f2f2f2; }

        .actions { display:flex; gap: 10px; justify-content:flex-end; }
        button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background:#fff; cursor:pointer; }
        button.primary { border-color:#111; background:#111; color:#fff; }

        .itinerary { display:grid; gap: 10px; }
        .item { border: 1px solid #e7e7e7; border-radius: 12px; padding: 12px; background:#fff; }
        .item-top { display:flex; justify-content:space-between; gap: 10px; }
        .time { font-weight: 800; }
        .badge { font-size: 12px; color:#666; }

        pre { white-space: pre-wrap; background:#0b0b0b; color:#f0f0f0; padding: 12px; border-radius: 12px; overflow:auto; }
    </style>
</head>
<body>
<h1>parisien</h1>
<p class="muted">Day 1~5 ì¤‘ í•˜ë£¨ë¥¼ ê³ ë¥´ê³ , ì•„ì¹¨/ì ì‹¬/ì €ë…ì„ ì–‘ìíƒì¼ë¡œ ì„ íƒí•˜ë©´ ì‹¤ì œ ëª…ì†Œ/ì¹´í˜ê°€ ë¼ì›Œì§„ í•˜ë£¨ ì½”ìŠ¤ê°€ ë‚˜ì™€.</p>

<div class="panel">
    <div class="day-tabs" id="dayTabs"></div>
</div>

<div id="dayView"></div>

<div class="panel" id="resultPanel" style="display:none;">
    <h2 id="conceptTitle" style="margin:0 0 12px;"></h2>
    <div class="itinerary" id="itinerary"></div>
    <details style="margin-top:12px;">
        <summary class="muted">ì›ë³¸ ì‘ë‹µ ë³´ê¸°</summary>
        <pre id="raw"></pre>
    </details>
</div>

<script>
    const PLACEHOLDER = "https://placehold.co/640x420?text=parisien";
    let days = [];
    let activeDay = 1;

    // ì €ì¥ë˜ëŠ” ì„ íƒ(optionId)
    const selections = new Map(); // key: `${day}-${slot}` -> optionId

    async function init() {
        const res = await fetch("/days");
        days = await res.json();

        renderDayTabs();
        renderDay(activeDay);
    }

    function renderDayTabs() {
        const wrap = document.getElementById("dayTabs");
        wrap.innerHTML = days.map(d => `
        <button class="tab ${d.day === activeDay ? "active" : ""}" data-day="${d.day}">Day ${d.day}</button>
      `).join("");

        wrap.querySelectorAll(".tab").forEach(btn => {
            btn.addEventListener("click", () => {
                activeDay = Number(btn.getAttribute("data-day"));
                document.getElementById("resultPanel").style.display = "none";
                renderDayTabs();
                renderDay(activeDay);
            });
        });
    }

    function renderDay(dayNum) {
        const plan = days.find(d => d.day === dayNum);
        const view = document.getElementById("dayView");
        if (!plan) return;

        view.innerHTML = `
        ${renderSlot(plan, "MORNING", "ğŸŒ… ì•„ì¹¨")}
        ${renderSlot(plan, "LUNCH", "ğŸ½ ì ì‹¬")}
        ${renderSlot(plan, "DINNER", "ğŸŒ™ ì €ë…")}
        <div class="panel">
          <div class="actions">
            <button id="resetBtn">ì„ íƒ ì´ˆê¸°í™”</button>
            <button class="primary" id="submitBtn">ì´ Day ì½”ìŠ¤ ë§Œë“¤ê¸°</button>
          </div>
        </div>
      `;

        // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
        view.querySelectorAll(".opt").forEach(card => {
            card.addEventListener("click", () => {
                const slot = card.getAttribute("data-slot");
                const optionId = card.getAttribute("data-option-id");
                selections.set(`${dayNum}-${slot}`, optionId);
                highlightSelected(dayNum, slot);
            });
        });

        // ì´ˆê¸° í•˜ì´ë¼ì´íŠ¸
        ["MORNING", "LUNCH", "DINNER"].forEach(slot => highlightSelected(dayNum, slot));

        document.getElementById("resetBtn").addEventListener("click", () => {
            ["MORNING", "LUNCH", "DINNER"].forEach(slot => selections.delete(`${dayNum}-${slot}`));
            ["MORNING", "LUNCH", "DINNER"].forEach(slot => highlightSelected(dayNum, slot));
            document.getElementById("resultPanel").style.display = "none";
        });

        document.getElementById("submitBtn").addEventListener("click", async () => {
            const m = selections.get(`${dayNum}-MORNING`);
            const l = selections.get(`${dayNum}-LUNCH`);
            const d = selections.get(`${dayNum}-DINNER`);

            if (!m) return alert("ì•„ì¹¨ì—ì„œ í•˜ë‚˜ë¥¼ ê³¨ë¼ì¤˜.");
            if (!l) return alert("ì ì‹¬ì—ì„œ í•˜ë‚˜ë¥¼ ê³¨ë¼ì¤˜.");
            if (!d) return alert("ì €ë…ì—ì„œ í•˜ë‚˜ë¥¼ ê³¨ë¼ì¤˜.");

            const payload = { morningOptionId: m, lunchOptionId: l, dinnerOptionId: d };

            const res = await fetch(`/days/${dayNum}/submit`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) return alert("ì œì¶œ ì‹¤íŒ¨: " + res.status);

            const out = await res.json();
            renderResult(out);
        });

        // ëª…ì†ŒëŠ” Wikipedia ì´ë¯¸ì§€ ìë™ ì‹œë„
        hydrateAttractionImagesFromWikipedia(view);
    }

    function renderSlot(plan, slotKey, slotTitle) {
        const slot = plan.slots.find(s => s.slot === slotKey);
        const a = slot.optionA;
        const b = slot.optionB;

        return `
        <div class="panel">
          <div class="slot-title">
            <h2>${slotTitle}</h2>
            <span>ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ</span>
          </div>
          <div class="grid-2">
            ${renderOption(plan.day, slotKey, a)}
            ${renderOption(plan.day, slotKey, b)}
          </div>
        </div>
      `;
    }

    function renderOption(dayNum, slotKey, opt) {
        const p = opt.place;
        return `
        <div class="opt" data-day="${dayNum}" data-slot="${slotKey}" data-option-id="${escapeHtml(opt.optionId)}"
             data-place-type="${escapeHtml(p.type)}" data-place-name="${escapeHtml(p.name)}">
          <div class="opt-head">
            <p class="opt-label">${escapeHtml(opt.label)}</p>
            <span class="badge">${escapeHtml(p.type)}</span>
          </div>
          <p class="opt-place">${escapeHtml(p.name)}</p>
          <img class="img" alt="${escapeHtml(p.name)}" src="${PLACEHOLDER}" loading="lazy">
        </div>
      `;
    }

    function highlightSelected(dayNum, slotKey) {
        const selectedId = selections.get(`${dayNum}-${slotKey}`);
        document.querySelectorAll(`.opt[data-day="${dayNum}"][data-slot="${slotKey}"]`).forEach(el => {
            const isSelected = el.getAttribute("data-option-id") === selectedId;
            el.classList.toggle("selected", isSelected);
        });
    }

    function renderResult(out) {
        document.getElementById("resultPanel").style.display = "block";
        document.getElementById("conceptTitle").textContent = `Day ${out.day} Â· ${out.conceptTitle}`;

        const wrap = document.getElementById("itinerary");
        wrap.innerHTML = (out.items || []).map(it => `
        <div class="item">
          <div class="item-top">
            <span class="time">${escapeHtml(it.time)} Â· ${escapeHtml(it.title)}</span>
            <span class="badge">${escapeHtml(it.place.type)}</span>
          </div>
          <div style="margin-top:6px; font-weight:800;">${escapeHtml(it.place.name)}</div>
          <div class="muted" style="margin-top:4px;">${escapeHtml(it.detail)}</div>
          <div class="muted" style="margin-top:6px;">(${Number(it.place.lat).toFixed(5)}, ${Number(it.place.lng).toFixed(5)})</div>
        </div>
      `).join("");

        document.getElementById("raw").textContent = JSON.stringify(out, null, 2);
        window.scrollTo({ top: document.getElementById("resultPanel").offsetTop - 10, behavior: "smooth" });
    }

    async function hydrateAttractionImagesFromWikipedia(scopeEl) {
        const cards = scopeEl.querySelectorAll('.opt[data-place-type="ATTRACTION"]');
        for (const card of cards) {
            const img = card.querySelector("img.img");
            const name = card.getAttribute("data-place-name");
            const url = await fetchWikipediaThumbnail(name);
            if (url) img.src = url;
        }
    }

    async function fetchWikipediaThumbnail(placeName) {
        const title = encodeURIComponent(placeName.replaceAll("â€™", "'"));
        const api = `https://en.wikipedia.org/api/rest_v1/page/summary/${title}`;
        try {
            const res = await fetch(api, { headers: { "Accept": "application/json" } });
            if (!res.ok) return null;
            const data = await res.json();
            return data?.thumbnail?.source || null;
        } catch (e) {
            return null;
        }
    }

    function escapeHtml(str) {
        return String(str)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
    }

    init().catch(err => console.error(err));
</script>
</body>
</html>
